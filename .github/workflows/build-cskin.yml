name: Build and Release Cskin

on:
  push:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # 必须，否则无法上传 release

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create tools directory
        run: mkdir -p tools

      - name: Download latest go-jsonnet
        id: download_jsonnet
        run: |
          set -e
          cd tools

          # 尝试获取 latest 版本号
          LATEST_TAG=$(curl -s https://api.github.com/repos/google/go-jsonnet/releases/latest | grep tag_name | cut -d '"' -f 4)

          if [ -z "$LATEST_TAG" ]; then
            echo "Failed to fetch latest release. Using fallback version v0.21.0."
            LATEST_TAG="v0.21.0"
          fi

          echo "Downloading go-jsonnet $LATEST_TAG"

          URL="https://github.com/google/go-jsonnet/releases/download/${LATEST_TAG}/go-jsonnet_Linux_x86_64.tar.gz"

          curl -L -o go-jsonnet.tar.gz "$URL"

          tar -xzf go-jsonnet.tar.gz
          chmod +x jsonnet

          echo "jsonnet path=$PWD/jsonnet" >> $GITHUB_OUTPUT

      - name: Run jsonnet
        run: |
          JSONNET_BIN="${{ steps.download_jsonnet.outputs.jsonnet }}"
          chmod +x "$JSONNET_BIN"
          "$JSONNET_BIN" -S -m ./ ./main.jsonnet

      - name: Prepare packaging directory
        run: |
          mkdir package
          TARGET="仿仓默认-元书"
          mkdir "package/$TARGET"

          # 复制仓库文件到 package 中，排除 .git/ .gitignore tools/
          rsync -av \
            --exclude=".git" \
            --exclude=".gitignore" \
            --exclude="tools" \
            "./" "package/$TARGET"

      - name: Zip to UTF-8 zip
        run: |
          cd package
          ZIPNAME="仿仓默认-元书.zip"
          zip -r "$ZIPNAME" "仿仓默认-元书"
          mv "$ZIPNAME" "../仿仓默认-元书.cskin"

      - name: Create prerelease-alpha and upload
        uses: softprops/action-gh-release@v2
        with:
          tag_name: prerelease-alpha
          name: prerelease-alpha
          prerelease: true
          draft: false
          overwrite: true    # 覆盖已有 release
          files: 仿仓默认-元书.cskin
